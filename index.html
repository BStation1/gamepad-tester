<script>
  let gamepadIndex = null;

  window.addEventListener("gamepadconnected", (e) => {
    gamepadIndex = e.gamepad.index;
    document.getElementById("gamepad-status").textContent = `تم العثور على دراع: ${e.gamepad.id} (أزرار: ${e.gamepad.buttons.length}, محاور: ${e.gamepad.axes.length})`;
    updateButtons(e.gamepad);
  });

  window.addEventListener("gamepaddisconnected", (e) => {
    gamepadIndex = null;
    document.getElementById("gamepad-status").textContent = "تم فصل الدراع. جاري البحث عن دراع...";
    document.getElementById("buttons").innerHTML = "";
  });

  function updateButtons(gamepad) {
    const buttonsContainer = document.getElementById("buttons");
    buttonsContainer.innerHTML = "";
    // DualSense عنده 17 زر، نعرضهم حسب الترتيب
    for (let i = 0; i < Math.min(17, gamepad.buttons.length); i++) {
      const button = document.createElement("div");
      button.className = `w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-gray-700 font-semibold ${i < 10 ? 'col-span-1' : 'col-span-2'}`;
      button.textContent = `B${i}`;
      button.id = `button-${i}`;
      buttonsContainer.appendChild(button);
    }
  }

  function updateGamepad() {
    if (gamepadIndex === null) {
      document.getElementById("gamepad-status").textContent = "لا يوجد دراع متصل. تأكد من التوصيل!";
      return;
    }

    const gamepad = navigator.getGamepads()[gamepadIndex];
    if (!gamepad) {
      document.getElementById("gamepad-status").textContent = "خطأ: الدراع غير متاح!";
      return;
    }

    // تحديث الأزرار
    gamepad.buttons.forEach((button, index) => {
      const buttonElement = document.getElementById(`button-${index}`);
      if (buttonElement) {
        buttonElement.classList.toggle("button-pressed", button.pressed);
      }
    });

    // تحديث المحاور (العصي) - DualSense يستخدم أول 4 محاور
    const leftStick = document.getElementById("left-stick");
    const rightStick = document.getElementById("right-stick");

    if (gamepad.axes.length >= 4) {
      const leftX = (gamepad.axes[0] + 1) * 25; // تحويل [-1,1] إلى [0,50]
      const leftY = (gamepad.axes[1] + 1) * 25;
      const rightX = (gamepad.axes[2] + 1) * 25;
      const rightY = (gamepad.axes[3] + 1) * 25;

      leftStick.style.transform = `translate(${leftX}px, ${leftY}px)`;
      rightStick.style.transform = `translate(${rightX}px, ${rightY}px)`;
    } else {
      document.getElementById("gamepad-status").textContent = `تحذير: عدد المحاور (${gamepad.axes.length}) أقل من المتوقع!`;
    }

    requestAnimationFrame(updateGamepad);
  }

  // بدء حلقة التحديث
  requestAnimationFrame(updateGamepad);
</script>